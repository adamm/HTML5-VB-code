<!doctype html>
<html>
  <head>
    <title>IndexedDB - HTML5.array.org</title>
    <!--[if lt IE 9]>
    <script src='http://html5shim.googlecode.com/svn/trunk/html5.js'></script>
    <![endif]-->
    <base href='http://192.168.1.11/~adamm/html5/chapter13/'>
    <script type='text/javascript' src='jquery-1.6.1.js'></script>
    <script type='text/javascript' src='highlight.min.js'></script>
    <link rel="stylesheet" href='highlight.min.css'>
    <link rel='stylesheet' type='text/css' media='all' href='base.css'>
    <link rel='stylesheet' type='text/css' media='screen and (max-width: 500px)' href='mobile.css'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=yes'>
    <meta content='text/html; charset=UTF-8' http-equiv='content-type'>
    <script type='text/javascript'>hljs.initHighlightingOnLoad();</script>
  </head>
  <body>
    <div class='content'>
    <header>
      <nav>
        <a href='index.html'>Home</a>
        <a href='tutorials/'>Tutorials</a>
        <a href='demos/'>Demos</a>
        <a href='vb/'>Visual&nbsp;Blueprint&trade;</a>
      </nav>
      <h1>HTML5.array.org</h1>
    </header>
    <section id='articles'>
      <h2>Demos</h2>
      <article class='demos'>
        <hgroup>
          <h3>IndexedDB</h3>
          <h4>Use the Correct IndexedDB API</h4>
          <h5>Synopsis</h5>
        </hgroup>
        <pre><code class='javascript'>var indexedDB = window.indexedDB || window.webkitIndexedDB || window.mozIndexedDB;
var IDBCursor = window.IDBCursor || window.webkitIDBCursor || window.mozIDBCursor;
var IDBDatabase = window.IDBDatabase || window.webkitIDBDatabase || window.mozIDBDatabase;
var IDBDatabaseError = window.IDBDatabaseError || window.webkitIDBDatabaseError || window.mozIDBDatabaseError;
var IDBDatabaseException = window.IDBDatabaseException || window.webkitIDBDatabaseException || window.mozIDBDatabaseException;
var IDBFactor = window.IDBFactor || window.webkitIDBFactor || window.mozIDBFactor;
var IDBIndex =  window.IDBIndex || window.webkitIDBIndex || window.mozIDBIndex;
var IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange || window.mozIDBKeyRange;
var IDBObjectStore = window.IDBObjectStore || window.webkitIDBObjectStore || window.mozIDBObjectStore;
var IDBRequest = window.IDBRequest || window.webkitIDBRequest || window.mozIDBRequest;
var IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction || window.mozIDBTransaction;
</code></pre>
        <hgroup>
          <h4>Open an IndexedDB Database</h4>
          <h5>Synopsis</h5>
        </hgroup>
        <pre><code class='javascript'>var db;
var openDB = indexedDB.open('myDatabase');
openDB.onsuccess = function(event) {
  db = event.target.result;
}
openDB.onerror = popupErrorEvent;

function popupErrorEvent(event) {
  console.log('Error ', event.target);
  alert('Error:' + event.target.errorCode + ": " +
    event.target.webkitErrorMessage + "\n(see console log)");
}
</code></pre>
        <hgroup>
          <h4>Create a New Object Store</h4>
          <h5>Synopsis</h5>
        </hgroup>
        <pre><code class='javascript'><span class='faded'>var db;</span>
var objectStore = 'myStore';
<span class='faded'>var openDB = indexedDB.open('myDatabase');
openDB.onsuccess = function(event) {
  db = event.target.result;</span>
  try {
    // Basic transaction call to trigger NOT_FOUND_ERR exception
    var store = db.transaction(objectStore, IDBTransaction.READ_ONLY).objectStore(objectStore);
    console.log('Loaded database and object store', db, store);
  } catch(e) {
    if ( e.code == IDBDatabaseException.NOT_FOUND_ERR ) {
      var request = db.setVersion('1.0');

      request.onsuccess = function(event) {
        var store = db.createObjectStore(objectStore, 
                      {keyPath: 'id', autoIncrement: true});
        console.log('Created store', store);
      }
      request.onerror = popupErrorEvent;
    }
  }
<span class=faded>}</span>
</code></pre>
        <hgroup>
          <h4>Store an Object</h4>
          <h5>Synopsis</h5>
        </hgroup>
        <pre><code class='javascript'>function addObject(object) {
  var transaction = db.transaction(objectStore, IDBTransaction.READ_WRITE);
  var store = transaction.objectStore(objectStore);
  var request = store.add(object);
  console.log('addObject', object, request);

  request.onsuccess = function(event) {
    // Assign the ID that was autogenerated to the object for rendering
    object.id = event.target.result;
    renderObject(object);
  };
  request.onerror = popupErrorEvent;
}
</code></pre>
        <hgroup>
          <h4>Retrieve an Object</h4>
          <h5>Synopsis</h5>
        </hgroup>
        <pre><code class='javascript'>function displayObjects(lowerBound, upperBound) {
  var transaction = db.transaction(objectStore, IDBTransaction.READ_ONLY, 0);
  var store = transaction.objectStore(objectStore);
  var request = store.openCursor();

  request.onsuccess = function(event) {
    if ( cursor = event.target.result ) {
      console.log('displayObject', cursor.value);
      <i>renderObject</i>(cursor.value);
      cursor.continue();
    }
  };
  request.onerror = popupErrorEvent;
}

function displayObjectById(id) {
  var transaction = db.transaction(objectStore, IDBTransaction.READ_ONLY, 0);
  var store = transaction.objectStore(objectStore);
  var request = store.get(id);

  request.onsuccess = function(event) {
    if ( cursor = event.target.result ) {
      console.log('displayObjectById', cursor.value);
      <i>renderObject</i>(cursor.value);
    }
  };
  request.onerror = popupErrorEvent;
}

</code></pre>
        <hgroup>
          <h4>Delete an Object</h4>
          <h5>Synopsis</h5>
        </hgroup>
        <pre><code class='javascript'>function deleteObjectById(id) {
  var transaction = db.transaction(objectStore, IDBTransaction.READ_WRITE, 0);
  var store = transaction.objectStore(objectStore);
  var request = store.delete(id);

  request.onsuccess = function(event) {
    console.log('deleteObjectById', id);
    // Use jQuery to hide the object from the browser
    $('<i>selector</i>#'+id).remove();
  };
  request.onerror = popupErrorEvent;
}
</code></pre>
        <hgroup>
          <h4>Delete an Object Store</h4>
          <h5>Synopsis</h5>
        </hgroup>
        <pre><code class='javascript'>function deleteObjectStore() {
  var request = db.setVersion('1.0');

  request.onsuccess = function(event) {
    db.deleteObjectStore(objectStore);
    console.log('Deleted object store', objectStore, 'from', db);
  }
  request.onerror = popupErrorEvent;
}
</code></pre>
        <h5>Example</h5>
        <style>
          article.example {
            margin: 10px;
          }
        </style>
        <script type="text/javascript">
          $(function(){
            // Merge the various IndexedDB interface names into properly
            // named variables. Falling back to the Webkit and Mozilla names
            // makes it possible for Chrome and Firefox to use the same code.
            var indexedDB = window.indexedDB || window.webkitIndexedDB || window.mozIndexedDB;
            var IDBDatabaseException = window.IDBDatabaseException || window.webkitIDBDatabaseException;
            var IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange;
            var IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction;
            // This shim is very flimsy. It is very likely to change as
            // IndexedDB becomes more stable and supported in more
            // browsers.

            var db, database = 'myDatabase';
            var objectStore = 'myStore';

            var openDB = indexedDB.open(database);
            openDB.onsuccess = function(event) {
              db = event.target.result;
              try {
                // Basic transaction call to trigger NOT_FOUND_ERR exception
                var store = db.transaction(objectStore, IDBTransaction.READ_ONLY).objectStore(objectStore);
                console.log('Loaded database and object store', db, store);
                displayObjects();
              } catch(e) {
                console.log('Transaction Exception', e);
                if ( e.code == IDBDatabaseException.NOT_FOUND_ERR ) {
                  var request = db.setVersion('1.0');

                  request.onsuccess = function(event) {
                    var store = db.createObjectStore(objectStore, 
                                  {keyPath: 'id', autoIncrement: true});
                    console.log('Created store', store);
                  }
                  request.onerror = popupErrorEvent;
                }
              }
            }
            openDB.onerror = popupErrorEvent;

            function popupErrorEvent(event) {
              console.log('Error ', event.target);
              alert('Error:' + event.target.errorCode + ": " +
                event.target.webkitErrorMessage + "\n(see console log)");
            }

            function addObject(object) {
              var transaction = db.transaction(objectStore, IDBTransaction.READ_WRITE);
              var store = transaction.objectStore(objectStore);
              var request = store.add(object);
              console.log('addObject', object, request);

              request.onsuccess = function(event) {
                // Assign the ID that was autogenerated to the object for rendering
                object.id = event.target.result;
                renderObject(object);
              };
              request.onerror = popupErrorEvent;
            }

            function displayObjects() {
              var transaction = db.transaction(objectStore, IDBTransaction.READ_ONLY);
              var store = transaction.objectStore(objectStore);
              var request = store.openCursor();

              request.onsuccess = function(event) {
                if ( cursor = event.target.result ) {
                  console.log('displayObject', cursor.value);
                  renderObject(cursor.value);
                  cursor.continue();
                }
              };
              request.onerror = popupErrorEvent;
            }

            function renderObject(data) {
              var container = $('ol#objects');
              var li = $('<li></li>');
              var text = JSON.stringify(data);
              var delImage = $('<img>');

              delImage.attr('src', 'images/gtk-close.png');
              delImage.css('vertical-align', 'middle');
              delImage.click(function(event) {
                deleteObjectById(data.id);
              });

              li.attr('id',data.id);
              li.text(text);
              li.append(delImage);
              container.append(li);
            }

            function deleteObjectById(id) {
              var transaction = db.transaction(objectStore, IDBTransaction.READ_WRITE);
              var store = transaction.objectStore(objectStore);
              var request = store.delete(id);

              request.onsuccess = function(event) {
                console.log('deleteObjectById', id);
                // Use jQuery to hide the object from the browser
                $('ol#objects li#'+id).remove();
              };
              request.onerror = popupErrorEvent;
            }

            function deleteObjectStore() {
              var request = db.setVersion('1.0');

              request.onsuccess = function(event) {
                db.deleteObjectStore(objectStore);
                console.log('Deleted object store', objectStore, 'from', db);
              }
              request.onerror = popupErrorEvent;
            }

            $('button#add-object').click(function(){
              try {
                var object = {};
                object[$('input#key1').val()] = $('input#value1').val();
                object[$('input#key2').val()] = $('input#value2').val();
                object[$('input#key3').val()] = $('input#value3').val();
                addObject(object);
              }
              catch(e) {
                console.log( "Exception error!!", e);
              }
            });
            $('button#delete-store').click(function(){
              deleteObjectStore();
            });
          });
        </script>
        <article class='example'>
          <ol id='objects'></ol>
          <input id='key1' type='text' value='key1' size='5'>: <input id='value1' type='text'><br>
          <input id='key2' type='text' value='key2' size='5'>: <input id='value2' type='text'><br>
          <input id='key3' type='text' value='key3' size='5'>: <input id='value3' type='text'>
          <button id='add-object'>Add Object</button>
          <button id='delete-store'>Delete Store</button><br>
        </article>
      </article>
    </section>
    <footer>
      &copy;2011 Adam McDaniel
    </footer>
    </div>
  </body>
</html>
